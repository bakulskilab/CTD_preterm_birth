 ---
title: "Preterm Birth and Environmental Chemicals in the CTD"
author: "Sean Harris, Kelly Bakulski"
date: "4/28/2020"
output:
  html_document:
    theme: spacelab
    highlight: tango
    toc: true
    number_sections: true
    toc_depth: 5
    toc_float:
      collapsed: true
      smooth_scroll: true
---

```{r install packages as needed, eval=FALSE, echo=FALSE}
install.packages("workflowr")
install.packages("plotly")
install.packages("miscTools")
install.packages("gplots")
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("LBE")
install.packages("PhViD")
install.packages("cowplot")
install.packages("ggpubr")
install.packages("knitr")
install.packages("kableExtra")
install.packages("readxl")
install.packages("gridExtra")
install.packages("forestplot")
install.packages("varhandle")
install.packages("VennDiagram")
install.packages("magrittr")
```



```{r load libraries, echo=FALSE, message=FALSE, warning=FALSE}
set.seed(2018)
library(plotly)
library(cowplot)
library(miscTools)
library(reshape2)
library(dplyr)
library(plyr)
library(ggpubr)
require(knitr)
library(grid)
library(gtable)
library(gplots)
library(kableExtra)
library(readxl)
library(PhViD)
library(grid)
library(gridExtra) 
library(forestplot)
library(varhandle)
library(VennDiagram)
library(RColorBrewer)
library(magrittr)
'%ni%' <- Negate('%in%')
options(scipen=999)
```


### Importing data
```{r filepath for data location}
#location<-"~/Google Drive/Placenta/CTD_preterm/Data files/" Kelly's file path for species & disease
location<-"E:/CTD_preterm/CTD Preterm birth analysis/Data files/" #Sean's path for file
#location.chem<-"~/Google Drive/Placenta/CTD_preterm/Datasets/Chemical-genes/" #Kelly's file path for chemicals
location.chem<-"E:/CTD_preterm/CTD Preterm birth analysis/Data files/Chemical-genes/" #Sean's path for file
#location.dis<-"~/Google Drive/Placenta/CTD_preterm/Data files/Dis-genes/" #Kelly's file path for disease genes
location.dis<-"E:/CTD_preterm/CTD Preterm birth analysis/Data files/Dis-genes/" #Sean's path for file
#Specify a custom file path for datasets
#location<-"G:/Mich/CTD project_uploaded/Preterm Birth project_uploaded/PTB_R tests/Datasets/Chem_gene/JC paper/Formatted for R" #Sean's file path
```

## Import genome data by species
```{r species genes, echo=TRUE, message=FALSE, warning=FALSE, eval=TRUE}
#Species genes
files <- paste0(c("Human", "Mouse", "Rat"), "_new.csv")
Genes <- lapply(lapply(files, function(x) read.csv(paste0(location,"Human, mouse and rat genes-ALL/",x), header=T, stringsAsFactors=F)), 
                function(y) y <- y[,2:3])

#name list
names(Genes) <- c("Hum", "Mus", "Rat")

# inspect gene number for each species
for (i in 1:length(Genes))  print(paste(names(Genes)[i], "has", nrow(Genes[[i]]), "genes"))
```




## Import Chemical-gene data
```{r chemgenes, echo=TRUE, message=FALSE, warning=TRUE}
# Chemical classification
chem_classification <-
        read.delim(paste0(location.chem,"chemical_classification_JC paper.txt"), header=T, stringsAsFactors=F) %>% 
        .$Chemical %>% paste0(., ".txt") %>% .[which(. %in% list.files(location.chem))]

C_G  <- lapply(chem_classification, function(x) read.delim(paste0(location.chem,x), sep="\t", header=T, stringsAsFactors=F))
colnames(C_G[[1]])

# name list
chem_classification <- gsub(".txt","", chem_classification)
names(C_G) <- chem_classification

# inspect genes number for each chemical 
for (i in 1:length(C_G))  print(paste(names(C_G)[i], "is associated with", nrow(C_G[[i]]), "genes"))
```



## Import preterm birth gene data
```{r preterm birth genes}
#Preterm birth genes
DG_f <- list.files(location.dis)
D_G  <- lapply(lapply(DG_f, function(x) read.csv(paste0(location.dis,x), header=T, stringsAsFactors=F)),
                            function(y) y <- y[, ])

D_G <- lapply(D_G, setNames, colnames(C_G[[1]])[5:6])

# name list
DG_f <- gsub("_.*","", DG_f)
names(D_G) <- DG_f

# inspect genes number for each organism
for (i in 1:length(D_G))  print(paste("Preterm birth in", names(D_G)[i], 
                                      "is associated with", nrow(D_G[[i]]), 
                                      "genes"))
```



## Checking Chemical-Gene list 

Overlap Chemical-Gene list with NEW genome data of Human, Mouse and Rat

### Human
```{r human}
# Check how many genes in chemical-gene list are NOT in genome list
lapply(C_G, function(x) summary(x[x$Organism == "Homo sapiens",]$GeneSymbol %in% Genes$Hum$Symbol))
        
C_G <- lapply(C_G, function(x) {
                   
                   # pick out genes which are NOT in genome list
                   noin <- x[x$Organism =="Homo sapiens",][
                           x[x$Organism =="Homo sapiens",]$GeneSymbol %ni% Genes$Hum$Symbol,]
                   
                   # Delete genes which are NOT in genome list
                   x <- x[which(rownames(x) %ni% row.names(noin)), ]
})               

# Check again               
lapply(C_G, function(x) summary(x[x$Organism == "Homo sapiens",]$GeneSymbol %in% Genes$Hum$Symbol))
```

###  Mouse
```{r mouse}
# Check how many genes in chemical-gene list are NOT in genome list
lapply(C_G, function(x) 
            summary(x[x$Organism == "Mus musculus",]$GeneSymbol %in% toupper(Genes$Mus$Symbol)))
        
C_G <- lapply(C_G, function(x) {
                   
                   # pick out genes which are NOT in genome list
                   noin <- x[x$Organism =="Mus musculus",][
                           x[x$Organism =="Mus musculus",]$GeneSymbol %ni% toupper(Genes$Mus$Symbol),]
                   
                   # Delete genes which are NOT in genome list
                   x <- x[which(rownames(x) %ni% row.names(noin)), ]
})               

# Check again             
lapply(C_G, function(x) 
            summary(x[x$Organism == "Mus musculus",]$GeneSymbol %in% toupper(Genes$Mus$Symbol)))
```

### Rat

```{r rat}
# Check how many genes in chemical-gene list are NOT in genome list
lapply(C_G, function(x) 
            summary(x[x$Organism == "Rattus norvegicus",]$GeneSymbol %in% toupper(Genes$Rat$Symbol)))
        
C_G <- lapply(C_G, function(x) {
                   
                   # pick out genes which are NOT in genome list
                   noin <- x[x$Organism =="Rattus norvegicus",][
                           x[x$Organism =="Rattus norvegicus",]$GeneSymbol %ni% toupper(Genes$Rat$Symbol),]
                   
                   # Delete genes which are NOT in genome list
                   x <- x[which(rownames(x) %ni% row.names(noin)), ]
})               

# Check again             
lapply(C_G, function(x) 
            summary(x[x$Organism == "Rattus norvegicus",]$GeneSymbol %in% toupper(Genes$Rat$Symbol)))
```


#Explore the data
# Exploring data

## Chemical-Gene

### Explore genes' number associated with different Species for each chemical 
```{r orgperchem}
# ***No. of organisms related with chemicals***
# Calculation function
org_num <- function(x, Data){
        num <- 0
        ary <- array(0, dim=c(length(x),1))
        for(i in 1:length(x)){
                num <- nrow(Data[Data$Organism == x[i],])
                ary[i,1] <- num
        }
        return(ary)
}

# get No. of genes associated with different organisms for each chemical
org_gene <- lapply(lapply(names(C_G), function(x) {
        
                                # org No. of each chemical
                                org <- C_G[[x]][!duplicated(C_G[[x]]$Organism), 7]
                                organ.num <- length(org)
                                print(paste("No. of Organisms in", x, "is", organ.num))
                                
                                # get genes No. by calculation function above
                                num <- org_num(org, C_G[[x]])
                                org_gene <- cbind.data.frame(org, num, stringsAsFactors=FALSE)
                                
                    # set colnames
                    }), setNames, c("Org", "Gene"))

names(org_gene) <- names(C_G)
```

#### PIE plots
```{r pie, fig.width=10, fig.height=17, fig.align='center',out.extra='angle=90',echo=FALSE}
plot_org <- lapply(lapply(names(C_G), function(x) {
        
                                # org No. of each chemical
                                org <- C_G[[x]][!duplicated(C_G[[x]]$Organism), 7]
                                organ.num <- length(org)
                                
                                # get genes No. by calculation function above
                                num <- org_num(org, C_G[[x]])
                                org_gene <- cbind.data.frame(org, num, stringsAsFactors=FALSE)
                                org_gene <- org_gene[which(org_gene[,1] %in% 
                                            c("Homo sapiens", "Mus musculus", "Rattus norvegicus")),]
                                
                    # set colnames
                    }), setNames, c("Org", "Gene"))

# Methylmercury has no Human or mouse genes
 plot_org[[13]] <- rbind.data.frame(plot_org[[13]],
                                    data.frame("Org"="Homo sapiens",
                                               "Gene"=0))
 
 plot_org[[13]] <- rbind.data.frame(plot_org[[13]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # Molybdenum has no Mouse genes
 plot_org[[14]] <- rbind.data.frame(plot_org[[14]],
                                    data.frame("Org"="Mus musculus", 
                                               "Gene"=0))
 # Tungsten has no Human genes
 plot_org[[15]] <- rbind.data.frame(plot_org[[15]],
                                    data.frame("Org"="Homo sapiens",
                                               "Gene"=0))
 # Thiocyanate has no Mouse or Rat genes
 plot_org[[20]] <- rbind.data.frame(plot_org[[20]],
                                    data.frame("Org"="Rattus norvegicus",
                                               "Gene"=0))

 plot_org[[20]] <- rbind.data.frame(plot_org[[20]],
                                    data.frame("Org"="Mus Musculus",
                                               "Gene"=0))
 # M2e phthalate has no Mouse or Rat genes
 plot_org[[24]] <- rbind.data.frame(plot_org[[24]],
                                    data.frame("Org"="Rattus norvegicus",
                                               "Gene"=0))

plot_org[[24]] <- rbind.data.frame(plot_org[[24]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # MbZ phthalate has no Mouse genes
 plot_org[[25]] <- rbind.data.frame(plot_org[[25]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # PCB187 has no Mouse or Rat genes
 plot_org[[34]] <- rbind.data.frame(plot_org[[34]],
                                    data.frame("Org"="Rattus norvegicus",
                                               "Gene"=0))
  
  plot_org[[34]] <- rbind.data.frame(plot_org[[34]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # BP-3 has no mouse genes
 plot_org[[35]] <- rbind.data.frame(plot_org[[35]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # DB phosphate has no mouse or rat genes
 
 plot_org[[51]] <- rbind.data.frame(plot_org[[51]],
                                    data.frame("Org"="Rattus norvegicus",
                                               "Gene"=0))
  
  plot_org[[51]] <- rbind.data.frame(plot_org[[51]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))

 # 3 xylene has no mouse genes
 plot_org[[52]] <- rbind.data.frame(plot_org[[52]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # M acid has no mouse genes
 plot_org[[57]] <- rbind.data.frame(plot_org[[57]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))
 # phen acid has no mouse or rat genes
 
  plot_org[[58]] <- rbind.data.frame(plot_org[[58]],
                                    data.frame("Org"="Rattus norvegicus",
                                               "Gene"=0))
  
  plot_org[[58]] <- rbind.data.frame(plot_org[[58]],
                                    data.frame("Org"="Mus musculus",
                                               "Gene"=0))

names(plot_org) <- names(C_G)
# order rows by name
plot_org <- lapply(plot_org, function(x) {x[with(x, order(Org)),]})


# pie plots
plot<-list()
plot<-
lapply(names(plot_org), function(p)  
        ggplot(plot_org[[p]], aes(x = factor(1), y = Gene, fill = Org)) +
                              geom_bar(width = 1, stat = "identity") +
                              coord_polar(theta = "y") +
               scale_fill_grey() +
                              theme(axis.text = element_blank(),
                                    axis.ticks = element_blank(),
                                    panel.grid  = element_blank()) +
                              labs(x="", y="", title=p)
)
# arrange plots function (use legend of first plot in list)
```


```{r pie, fig.width=10, fig.height=17, fig.align='center',out.extra='angle=90',echo=FALSE}
grid_arrange_shared_legend <- function(x) {

        plot <- x
        g <- ggplotGrob(plot[[1]] + theme(legend.position="bottom"))$grobs
        legend <- g[[which(sapply(g, function(x) x$name) == "guide-box")]]
        lheight <- sum(legend$height)
        grid.arrange(
                do.call(arrangeGrob, lapply(plot, function(x)
                        x + 
                        # theme(legend.position="none",
                        # axis.text = element_blank(),
                        # axis.ticks = element_blank(),
                        # panel.grid  = element_blank(),
                        # plot.title = element_text(size = 10, 
                        #                           face = "bold",
                        #                           hjust = 0.5))
                        theme_bw() +
                        theme(axis.ticks=element_blank(),
                              axis.text.y=element_blank(),
                              axis.text.x=element_blank(),
                              axis.title=element_blank(),
                              legend.position="none",
                              panel.grid.major=element_blank(),
                              panel.grid.minor=element_blank(),
                              panel.border=element_blank(),
                              plot.title = element_text(size = 10, 
                                                  face = "bold",
                                                  hjust = 0.5))
                        )),
                legend, ncol = 1,
                heights = unit.c(unit(1.01, "npc") - lheight, lheight))
}

grid_arrange_shared_legend(plot)
```


#Checking Disease Genelist
Check Unique genes for each chemical
```{r uniquechemgene}
# Check Unique (Human)
uniq.human <- 
        do.call(rbind, 
        lapply(C_G, function(x) length(unique(x[x$Organism == "Homo sapiens",]$GeneId))))

# Check Unique (Rat)
uniq.rat <- 
        do.call(rbind, 
        lapply(C_G, function(x) length(unique(x[x$Organism == "Rattus norvegicus",]$GeneId))))

# Check Unique (mouse)
uniq.mus <- 
        do.call(rbind, 
        lapply(C_G, function(x) length(unique(x[x$Organism == "Mus musculus",]$GeneId))))
```

```{r}
# Check unique genes for each chemical 
# Check Unique (Human)

uniq.human <- 
        do.call(rbind, 
        lapply(C_G, function(x) length(unique(x[x$Organism == "Homo sapiens",]$GeneId))))

#total number of genes
N <- nrow(Genes$Hum); N

# Get all related human genes for each chemical
CGH <- lapply(C_G, function(x) x[x$Organism == "Homo sapiens", 5:6][!duplicated(
                               x[x$Organism == "Homo sapiens", 5:6]$GeneId),]) 

# No. of Genes associated with both Chemicals and PTB
a <- sapply(CGH, function(x) sum(x$GeneSymbol %in% D_G$Hum$GeneSymbol)); a<-as.matrix(a, ncol=1)

# Unique No. of huamn genes for each chemical
N0_ <- uniq.human

# No. of human genes associated w/ PTB
N_0 <- nrow(D_G$Hum)

b = N0_ - a;
c = N_0 - a;
d = N-a-b-c;
N1_ = N - N0_; 
N_1 = N - N_0;

Hum_t <- list()
for (i in 1:length(C_G)) {
        
        Hum_t[[i]] <- matrix(c(a[i], b[i], N0_[i], 
                               c[i], d[i], N1_[i], 
                               N_0,  N_1,  N), ncol=3, byrow=T)
        
        rownames(Hum_t[[i]]) <- c("Yes","No","Total")
        colnames(Hum_t[[i]]) <- c("Yes","No","Total")
        
        Hum_t[[i]] <- as.data.frame(Hum_t[[i]])
}
        
names(Hum_t) <- names(C_G)
lapply(names(Hum_t), function(x) {
                   kable(Hum_t[[x]],
                   caption = paste0(x, "-Gene-PTB   ")) %>%  
                   kable_styling(full_width = F)
                })
```





Venn plots
 
```{r venn, fig.width=4, fig.height=4, fig.align='center',out.extra='angle=90', echo=FALSE}
for (i in seq_along(Hum_t)) {
        
        grid.newpage()
        draw.pairwise.venn(area1=Hum_t[[i]][1,3], area2=Hum_t[[i]][3,1],
                           cross.area=Hum_t[[i]][1,1], alpha=rep(.5,2),
                           ext.text=F,cex=c(1.8,1.4,1.8),cat.cex=rep(1.3,2),
                           cat.pos = rep( ifelse( abs(Hum_t[[i]][1,3]-
                                                  Hum_t[[i]][3,1]) <
                                                  500, 165, 330), 2), 
                           cat.dist=rep(0.025,2),rotation.degree = 50,
                           cat.col = c("dodgerblue3","firebrick4"),
                           category=c(names(Hum_t)[i], "Preterm Birth"),
                           lty=rep("blank",2), fill=c("light blue", "pink"),    
                           label.col=c("dodgerblue3", "black", "firebrick4"))
}
```

#Chi-square tests
```{r chisq, warning=FALSE}
# see whether chi-squared distribution can be satisfied for each chemical
try_chisq <- try(lapply(Hum_t, function(x) chisq.test(x[1:2,1:2], correct=F)))

chi_hum <- sapply(try_chisq, function(y) {
        
        # when there're low expected cell count, using 'N-1' chi-square
        if (y$expected[1,1]>=1 & y$expected[1,2]>=1 & y$expected[2,1]>=1 & y$expected[2,2]>=1) {
                if (y$expected[1,1]<5|y$expected[1,2]<5|y$expected[2,1]<5|y$expected[2,2]<5) { 
                        chisq <- (y$statistic)*N/(N-1)
                        newp  <- pchisq(chisq, df=1, lower.tail=F)
                        cell_count <- "< 5"
                }
                else  {
                        chisq <- y$statistic
                        newp  <- y$p.value
                        cell_count <- round(y$expected[1,1], 2)
                }
        }
        else {
                chisq <- NA
                newp  <- NA
                cell_count <- "< 1"
        }
        
        return(c(chisq_hum=chisq, newp_hum=newp, cell_count_hum=cell_count))
})
chi_hum <- as.data.frame(chi_hum)
Chi_Squared_Stat <- chi_hum["chisq_hum",] %>% unfactor %>% t %>% as.data.frame
Chi_Squared_p_value <- chi_hum["newp_hum",] %>% unfactor %>% t %>% as.data.frame
```

#Fisher's test
```{r fisher}
# Fisher test
fisher <- lapply(Hum_t, function(x) fisher.test(x[1:2,1:2]))

# Extract fisher OR's
Fisher_Odds_Ratio <- do.call(rbind.data.frame, lapply(fisher, function(x) x$estimate))

# Extract fisher p-values
Fisher_p_value  <- do.call(rbind.data.frame, lapply(fisher, function(x) x$p.value))

# Extract fisher CI
Fisher_lower <- do.call(rbind.data.frame, lapply(fisher, function(x) x$conf.int[1]))
Fisher_upper <- do.call(rbind.data.frame, lapply(fisher, function(x) x$conf.int[2]))
```

##PRR
```{r prr}
# PRR matrix, containing PRR values, lower bounds and upper bounds
PRR <- as.data.frame(sapply(Hum_t, function(x) {
                                PRR <- (x[1,1]/x[1,3])/(x[2,1]/x[2,3])
                                s <- sqrt(1/x[1,1] + 1/x[2,1] - 
                                          1/(x[1,1]+x[1,2])   - 
                                          1/(x[2,1]+x[2,2]))
                                prr.low <- PRR/exp(1.96*s)
                                prr.up  <- PRR*exp(1.96*s)
                
                                PRR <- rbind(PRR, s, prr.low, prr.up)
}))

# extract PRR values
prr <- t(PRR[1,])
```

## Statistical Tests results for each chemical by preterm birth in humans
```{r chemstat, echo=FALSE, message=FALSE}
Table_hum <- cbind.data.frame(Chi_Squared_Stat, Chi_Squared_p_value, 
                            Fisher_Odds_Ratio, Fisher_p_value, prr) %>% na.omit

colnames(Table_hum) <- c("Chi_Squared_Stat", "Chi_Squared_p_value", 
                       "Fisher_Odds_Ratio", "Fisher_p_value", "PRR")

# Bonferroni correction
Table_hum$Chi_Squared_p_value <-p.adjust(Table_hum$Chi_Squared_p_value, method="bonferroni")
Table_hum$Fisher_p_value <-p.adjust(Table_hum$Fisher_p_value, method="bonferroni")

sum_hum <- cbind.data.frame(Chi_Squared_Stat, Chi_Squared_p_value, 
                            Fisher_Odds_Ratio, Fisher_p_value, prr) 
sum_hum[which(rownames(sum_hum) %in% rownames(Table_hum)), ] = Table_hum
sum_hum <- cbind.data.frame(sum_hum[,-5], Fisher_lower, Fisher_upper, t(PRR))
sum_hum[apply(is.na(sum_hum), 1, any),] <- NA


colnames(sum_hum) <- c("Chi_Squared_Stat", "Chi_Squared_p_value", 
                       "Fisher_Odds_Ratio", "Fisher_p_value", 
                       "Fisher_CI_lower", "Fisher_CI_upper", 
                       "PRR", "sqrt", "PRR_CI_lower", "PRR_CI_upper")


for (i in 1:nrow(Table_hum)) {
        for (j in 1:ncol(Table_hum)) {
               if (Table_hum[i,j] == 0.0005/nrow(Table_hum)) Table_hum[i,j] <- "< 0.000"
               else Table_hum[i,j] <- round(as.numeric(Table_hum[i,j]), 4) 
       }
}

kable(Table_hum,
      caption=paste("Statistical Tests for each chemical by 
                     Preterm Birth in humans 
                     ( CUT-OFF =", round(0.05/nrow(Table_hum), 4),
                    ")")) %>% 
      kable_styling(full_width = F)
```


## Cross Validation
```{r crossval, echo=FALSE,results='hide',fig.keep='all',message=FALSE}
cv_int  <- list(); cv_gene <- list(); cv_rac  <- list()
chisq_test <- array(); fisher_test <- array()
# No. of random samples
cut_offs <- c(100, 500, 1000, 2500, 5000, 10000)
# set color
cols  <- colorRampPalette(brewer.pal(12, "Set3"), alpha=TRUE)(length(cut_offs))

lapply(cut_offs, function(N0_) {
        
        for (i in 1:1000) {
                
                # random sample
                cv_int[[i]]  <- sample.int(N, N0_)              
                cv_gene[[i]] <- Genes$Hum[cv_int[[i]],]      
                # find intersections between random sample and Disease-Gene list of human
                cv_rac[[i]]  <- cv_gene[[i]][which(cv_gene[[i]]$Symbol %in% D_G$Hum$GeneSymbol),] 
        
                a = nrow(cv_rac[[i]])
                b = N0_ - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - N0_; 
                N_1 = N - N_0;
        
                Table <- matrix(c(a,b,N0_,c,d,N1_,N_0,N_1,N), ncol=3, byrow=T)
                Table <- as.data.frame.matrix(Table)
                
                if (N0_ <= 1000) {
                        chisq_res <- chisq.test(Table[1:2,1:2], simulate.p.value=T)
                        chisq_test[i] <- chisq_res$p.value
                } else {
                        chisq_res <- chisq.test(Table[1:2,1:2], correct=F)
                        chisq_test[i] <- chisq_res$p.value       
                }
                
                
                fisher_res <- fisher.test(Table[1:2,1:2])
                fisher_test[i] <- fisher_res$p.value
                
        }

        hist(chisq_test, las=1, col="dodgerblue", breaks=20,
             xlim=c(0,1), ylim=c(0,600),
             xlab="Chi-squared p-values for association",
             main=as.character(paste0("Chisq, Sample size = ", N0_)))
        
         hist(fisher_test, las=1, col="darkorange", breaks=20,
             xlim=c(0,1), ylim=c(0,600),
             xlab="Fisher's test p-values for association",
             main=as.character(paste0("Fisher, Sample size = ", N0_)))
})
```

### Summary plot of cross validation
```{r plotcrossval, fig.width=8, fig.height=6, fig.align='center',out.extra='angle=90', echo=FALSE}
chisq_test_hum = fisher_test_hum <- data.frame(matrix(NA, nrow=1000, ncol=length(cut_offs)))
colnames(chisq_test_hum) = colnames(fisher_test_hum) <- paste("sample size =", cut_offs)

for(k in 1:length(cut_offs)) {
    for (i in 1:1000) {
                
                # random sample
                cv_int  <- sample.int(N, cut_offs[k])              
                cv_gene <- Genes$Hum[cv_int,]      
                # find interactions between random sample and Disease-Gene list of Mouse
                cv_rac  <- cv_gene[which(toupper(cv_gene$Symbol) %in% D_G$Hum$GeneSymbol),] 
                
                a = nrow(cv_rac)
                b = cut_offs[k] - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - cut_offs[k]; 
                N_1 = N - N_0;
                
                Table <- matrix(c(a,b,cut_offs[k],c,d,N1_,N_0,N_1,N), ncol=3, byrow=T)
                Table <- as.data.frame.matrix(Table)
                
                if (cut_offs[k] <= 1000) {
                        chisq_res  <- chisq.test(Table[1:2,1:2], simulate.p.value=T)
                        chisq_test_hum[i,k] <- chisq_res$p.value
                } else {
                        chisq_res  <- chisq.test(Table[1:2,1:2], correct=F)
                        chisq_test_hum[i,k] <- chisq_res$p.value       
                }
                
                
                fisher_res <- fisher.test(Table[1:2,1:2])
                fisher_test_hum[i,k] <- fisher_res$p.value
                
    }
}

cl <- rainbow(6)

plot(density(chisq_test_hum[,1]), lwd=1, col=cl[1], type = 'b',
     xlab="p-value for association", 
     ylab="Density", main="Chi-squared p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6){ lines(density(chisq_test_hum[,i]), lwd=1, col = cl[i], type = 'b') }
abline(v = 0.05/nrow(Table_hum), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_hum), 3)), col="black") 
legend("topleft", legend=colnames(chisq_test_hum), fill=cl[1:6], cex=0.75)

plot(density(fisher_test_hum[,1]), lwd=1, col=cl[1], type = 'b',
     xlab="p-value for association", 
     ylab="Density", main="Fisher Exact Test p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6) {lines(density(fisher_test_hum[,i]), lwd=1, col = cl[i], type = 'b')}
abline(v = 0.05/nrow(Table_hum), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_hum), 3)), col="black") 
legend("topleft", legend=colnames(fisher_test_hum), fill=cl[1:6], cex=0.75)

# use lines instead of dots and increase the density smoothing with "adjust"
plot(density(chisq_test_hum[,1], adjust=3), lwd=3, col=cl[1], type = 'l',
     xlab="p-value for association", 
     ylab="Density", main="Chi-squared p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6){ lines(density(chisq_test_hum[,i], adjust=3), lwd=3, col = cl[i], type = 'l') }
abline(v = 0.05/nrow(Table_hum), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_hum), 3)), col="black") 
legend("topleft", legend=colnames(chisq_test_hum), fill=cl[1:6], cex=0.75)

plot(density(fisher_test_hum[,1], adjust=3), lwd=3, col=cl[1], type = 'l',
     xlab="p-value for association", 
     ylab="Density", main="Fisher Exact Test p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6) {lines(density(fisher_test_hum[,i], adjust=3), lwd=3, col = cl[i], type = 'l')}
abline(v = 0.05/nrow(Table_hum), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_hum), 3)), col="black") 
legend("topleft", legend=colnames(fisher_test_hum), fill=cl[1:6], cex=0.75)

```




# 2x2 Tables (Mouse)
Total No. Genes
```{r mousetotalgene}
N <- nrow(Genes$Mus); N
```

Number in tables
```{r nograpes2, results="asis"}

# Get all related Mouse genes for each chemical
CGM <- lapply(C_G, function(x) x[x$Organism == "Mus musculus", 5:6][!duplicated(
                               x[x$Organism == "Mus musculus", 5:6]$GeneId),]) 

# No. of Genes associated with both Chemicals and S.A.
a <- sapply(CGM, function(x) sum(x$GeneSymbol %in% D_G$Mus$GeneSymbol)); a<-as.matrix(a, ncol=1)

                # Unique No. of huamn genes for each chemical
                N0_ <- uniq.mus

                # No. of Mouse genes associated w/ S.A.
                N_0 <- nrow(D_G$Mus)

                b = N0_ - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - N0_; 
                N_1 = N - N_0;

                Mus_t <- list()
                for (i in 1:length(C_G)) {
        
                        Mus_t[[i]] <- matrix(c(a[i], b[i], N0_[i], 
                                               c[i], d[i], N1_[i], 
                                               N_0,  N_1,  N), ncol=3, byrow=T)
        
                        colnames(Mus_t[[i]]) <- c("Yes","No","Total")
                        rownames(Mus_t[[i]]) <- c("Yes","No","Total")
        
                        Mus_t[[i]] <- as.data.frame(Mus_t[[i]])
}
names(Mus_t) <- names(C_G)

lapply(names(Mus_t), function(x) {
                   kable(Mus_t[[x]],
                   caption = paste0(x, "-Gene-PTB")) %>%  
                   kable_styling(full_width = F)})

```

Venn Plots
```{r fig.width=4, fig.height=4, fig.align='center',out.extra='angle=90', echo=FALSE}

for (i in seq_along(Mus_t)) {
        
        grid.newpage()
        draw.pairwise.venn(area1=Mus_t[[i]][1,3], area2=Mus_t[[i]][3,1],
                           cross.area=Mus_t[[i]][1,1], alpha=rep(.5,2),
                           ext.text=F,cex=c(1.8,1.4,1.8),cat.cex=rep(1.3,2),
                           cat.pos = rep( ifelse( abs(Mus_t[[i]][1,3]-
                                                  Mus_t[[i]][3,1]) <
                                                  500, 165, 330), 2), 
                           cat.dist=rep(0.025,2),rotation.degree = 50,
                           cat.col = c("dodgerblue3","firebrick4"),
                           category=c(names(Mus_t)[i], "Preterm Birth"),
                           lty=rep("blank",2), fill=c("light blue", "pink"), 
                           label.col=c("dodgerblue3", "black", "firebrick4"))
}

```
# Tests and Results (Mouse)

## Chi-Squared Test

```{r warning=FALSE}
# see whether chi-squared distribution can be satisfied for each chemical
try_chisq <- try(lapply(Mus_t, function(x) chisq.test(x[1:2,1:2], correct=F)))

chi_mus <- sapply(try_chisq, function(y) {
        
        # when there're low expected cell count, using 'N-1' chi-square
        if (y$expected[1,1]>=1 & y$expected[1,2]>=1 & y$expected[2,1]>=1 & y$expected[2,2]>=1) {
                if (y$expected[1,1]<5|y$expected[1,2]<5|y$expected[2,1]<5|y$expected[2,2]<5) {
                        chisq_mus <- (y$statistic)*N/(N-1)
                        newp_mus  <- pchisq(chisq_mus, df=1, lower.tail=F)
                        cell_count_mus <- "< 5"
                }
                else  {
                        chisq_mus <- y$statistic
                        newp_mus  <- y$p.value
                        cell_count_mus <- round(y$expected[1,1], 2)
                }
        }
        else {
                chisq_mus <- NA
                newp_mus  <- NA
                cell_count_mus <- "< 1"
        }
        
        return(c(chisq_mus=chisq_mus, newp_mus=newp_mus, cell_count_mus=cell_count_mus))
})
chi_mus <- as.data.frame(chi_mus)
Chi_Squared_Stat_mus <- chi_mus["chisq_mus",]  %>% unfactor %>% t %>% as.data.frame
Chi_Squared_p_value_mus <- chi_mus["newp_mus",] %>% unfactor %>% t %>% as.data.frame
```

## Fisher's Enrichment Test
```{r}
# Fisher test
fisher_mus <- lapply(Mus_t, function(x) fisher.test(x[1:2,1:2]))

# Extract fisher OR's
Fisher_Odds_Ratio_mus <- do.call(rbind.data.frame, lapply(fisher_mus, function(x) x$estimate))

# Extract fisher p-values
Fisher_p_value_mus  <- do.call(rbind.data.frame, lapply(fisher_mus, function(x) x$p.value))

# 95% CI
Fisher_lower_mus  <- do.call(rbind.data.frame, lapply(fisher_mus, function(x) x$conf.int[1]))
Fisher_upper_mus  <- do.call(rbind.data.frame, lapply(fisher_mus, function(x) x$conf.int[2]))
```

## PRR
```{r}
# PRR matrix, containing PRR values, lower bounds and upper bounds
PRR_mus <- as.data.frame(sapply(Mus_t, function(x) {
                                PRR <- (x[1,1]/x[1,3])/(x[2,1]/x[2,3])
                                s <- sqrt(1/x[1,1] + 1/x[2,1] - 
                                          1/(x[1,1]+x[1,2])   - 
                                          1/(x[2,1]+x[2,2]))
                                prr.low <- PRR/exp(1.96*s)
                                prr.up  <- PRR*exp(1.96*s)
                
                                PRR <- rbind(PRR, s, prr.low, prr.up)
}))

# extract PRR values
prr_mus <- t(PRR_mus[1,])
```

## Statistical Tests for each chemical by preterm birth in Mouse
```{r echo=FALSE, message=FALSE}
Table_mus <- cbind.data.frame(Chi_Squared_Stat_mus, Chi_Squared_p_value_mus, 
                              Fisher_Odds_Ratio_mus, Fisher_p_value_mus, prr_mus) %>% na.omit

colnames(Table_mus) <- c("Chi_Squared_Stat", "Chi_Squared_p_value", 
                       "Fisher_Odds_Ratio", "Fisher_p_value", "PRR")

Table_mus$Chi_Squared_p_value <-p.adjust(Table_mus$Chi_Squared_p_value, method="bonferroni")
Table_mus$Fisher_p_value <-p.adjust(Table_mus$Fisher_p_value, method="bonferroni")

sum_mus <- cbind.data.frame(Chi_Squared_Stat_mus, Chi_Squared_p_value_mus, 
                              Fisher_Odds_Ratio_mus, Fisher_p_value_mus, prr_mus) 
sum_mus[which(rownames(sum_mus) %in% rownames(Table_mus)),] = Table_mus
sum_mus <- cbind.data.frame(sum_mus[,-5], Fisher_lower_mus, Fisher_upper_mus, t(PRR_mus))
sum_mus[apply(is.na(sum_mus), 1, any),] <- NA

colnames(sum_mus) <- c("Chi_Squared_Stat", "Chi_Squared_p_value", 
                       "Fisher_Odds_Ratio", "Fisher_p_value", 
                       "Fisher_CI_lower", "Fisher_CI_upper", 
                       "PRR", "sqrt", "PRR_CI_lower", "PRR_CI_upper")

for (i in 1:nrow(Table_mus)) {
        for (j in 1:ncol(Table_mus)) {
               if ( Table_mus[i,j]< 0.0005/nrow(Table_mus)) Table_mus[i,j] <- "< 0.000" 
               else Table_mus[i,j] <- round(as.numeric(Table_mus[i,j]), 4) 
        }
}

kable(Table_mus,
      caption=paste("Statistical Tests for each chemical by 
                     Preterm Birth in mouse   
                     ( CUT-OFF =", round(0.05/nrow(Table_mus), 4),
                    ")")) %>% 
      kable_styling(full_width = F)
```

## Cross Validation
```{r echo=FALSE,results='hide',fig.keep='all',message=FALSE}
cv_int  <- list(); cv_gene <- list(); cv_rac  <- list()
chisq_test <- array(); fisher_test <- array()

cross_val_mus <- sapply(cut_offs, function(N0_) {
        
        for (i in 1:1000) {
                
                # random sample
                cv_int[[i]]  <- sample.int(N, N0_)              
                cv_gene[[i]] <- Genes$Mus[cv_int[[i]],]      
                # find interactions between random sample and Disease-Gene list of Mouse
                cv_rac[[i]]  <- cv_gene[[i]][which(toupper(cv_gene[[i]]$Symbol) %in% D_G$Mus$GeneSymbol),] 
        
                a = nrow(cv_rac[[i]])
                b = N0_ - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - N0_; 
                N_1 = N - N_0;
        
                Table <- matrix(c(a,b,N0_,c,d,N1_,N_0,N_1,N), ncol=3, byrow=T)
                Table <- as.data.frame.matrix(Table)
                
                if (N0_ <= 1000) {
                        chisq_res <- chisq.test(Table[1:2,1:2], simulate.p.value=T)
                        chisq_test[i] <- chisq_res$p.value
                } else {
                        chisq_res <- chisq.test(Table[1:2,1:2], correct=F)
                        chisq_test[i] <- chisq_res$p.value       
                }
                
                
                fisher_res <- fisher.test(Table[1:2,1:2])
                fisher_test[i] <- fisher_res$p.value
                
        }

        hist(chisq_test, las=1, col="dodgerblue", breaks=20,
             xlim=c(0,1), ylim=c(0,600),
             xlab="Chi-squared p-values for association",
             main=as.character(paste0("Chisq, Sample Size = ", N0_)))
        
         hist(fisher_test, las=1, col="darkorange", breaks=20,
             xlim=c(0,1), ylim=c(0,600),
             xlab="Fisher's test p-values for association",
             main=as.character(paste0("Fisher, Sample Size = ", N0_)))
})
```

### Summary plot of cross validation
```{r plotcrossval, fig.width=8, fig.height=6, fig.align='center',out.extra='angle=90', echo=FALSE}
chisq_test_mus = fisher_test_mus <- data.frame(matrix(NA, nrow=1000, ncol=length(cut_offs)))
colnames(chisq_test_mus) = colnames(fisher_test_mus) <- paste("sample size =", cut_offs)

for(k in 1:length(cut_offs)) {
    for (i in 1:1000) {
                
                # random sample
                cv_int  <- sample.int(N, cut_offs[k])              
                cv_gene <- Genes$Mus[cv_int,]      
                # find interactions between random sample and Disease-Gene list of Mouse
                cv_rac  <- cv_gene[which(toupper(cv_gene$Symbol) %in% D_G$Mus$GeneSymbol),] 
                
                a = nrow(cv_rac)
                b = cut_offs[k] - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - cut_offs[k]; 
                N_1 = N - N_0;
                
                Table <- matrix(c(a,b,cut_offs[k],c,d,N1_,N_0,N_1,N), ncol=3, byrow=T)
                Table <- as.data.frame.matrix(Table)
                
                if (cut_offs[k] <= 1000) {
                        chisq_res  <- chisq.test(Table[1:2,1:2], simulate.p.value=T)
                        chisq_test_mus[i,k] <- chisq_res$p.value
                } else {
                        chisq_res  <- chisq.test(Table[1:2,1:2], correct=F)
                        chisq_test_mus[i,k] <- chisq_res$p.value       
                }
                
                
                fisher_res <- fisher.test(Table[1:2,1:2])
                fisher_test_mus[i,k] <- fisher_res$p.value
                
    }
}

cl <- rainbow(6)

plot(density(chisq_test_mus[,1]), lwd=1, col=cl[1], type = 'b',
     xlab="p-value for association", 
     ylab="Density", main="Chi-squared p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6){ lines(density(chisq_test_mus[,i]), lwd=1, col = cl[i], type = 'b') }
abline(v = 0.05/nrow(Table_mus), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_mus), 3)), col="black") 
legend("topleft", legend=colnames(chisq_test_mus), fill=cl[1:6], cex=0.75)

plot(density(fisher_test_mus[,1]), lwd=1, col=cl[1], type = 'b',
     xlab="p-value for association", 
     ylab="Density", main="Fisher Exact Test p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6) {lines(density(fisher_test_mus[,i]), lwd=1, col = cl[i], type = 'b')}
abline(v = 0.05/nrow(Table_mus), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_mus), 3)), col="black") 
legend("topleft", legend=colnames(fisher_test_mus), fill=cl[1:6], cex=0.75)

# use lines instead of dots and increase the density smoothing with "adjust"
plot(density(chisq_test_mus[,1], adjust=3), lwd=3, col=cl[1], type = 'l',
     xlab="p-value for association", 
     ylab="Density", main="Chi-squared p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6){ lines(density(chisq_test_mus[,i], adjust=3), lwd=3, col = cl[i], type = 'l') }
abline(v = 0.05/nrow(Table_mus), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_mus), 3)), col="black") 
legend("topleft", legend=colnames(chisq_test_mus), fill=cl[1:6], cex=0.75)

plot(density(fisher_test_mus[,1], adjust=3), lwd=3, col=cl[1], type = 'l',
     xlab="p-value for association", 
     ylab="Density", main="Fisher Exact Test p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6) {lines(density(fisher_test_mus[,i], adjust=3), lwd=3, col = cl[i], type = 'l')}
abline(v = 0.05/nrow(Table_mus), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_mus), 3)), col="black") 
legend("topleft", legend=colnames(fisher_test_mus), fill=cl[1:6], cex=0.75)

```

# 2x2 Tables (Rat)
Total No. Genes
```{r}
N <- nrow(Genes$Rat); N
```

Number in tables
```{r nograpes3, results="asis"}

# Get all related rat genes for each chemical
CGR <- lapply(C_G, function(x) x[x$Organism == "Rattus norvegicus", 5:6][!duplicated(
                               x[x$Organism == "Rattus norvegicus", 5:6]$GeneId),]) 

# No. of Genes associated with both Chemicals and S.A.
a <- sapply(CGR, function(x) sum(x$GeneSymbol %in% D_G$Rat$GeneSymbol)); a<-as.matrix(a, ncol=1)

# Unique No. of huamn genes for each chemical
N0_ <- uniq.rat

# No. of Rat genes associated w/ S.A.
N_0 <- nrow(D_G$Rat)

b = N0_ - a;
c = N_0 - a;
d = N-a-b-c;
N1_ = N - N0_; 
N_1 = N - N_0;

Rat_t <- list()
for (i in 1:length(C_G)) {
        
        Rat_t[[i]] <- matrix(c(a[i], b[i], N0_[i], 
                               c[i], d[i], N1_[i], 
                               N_0,  N_1,  N), ncol=3, byrow=T)
        
        colnames(Rat_t[[i]]) <- c("Yes","No","Total")
        rownames(Rat_t[[i]]) <- c("Yes","No","Total")
        
        Rat_t[[i]] <- as.data.frame(Rat_t[[i]])
}
names(Rat_t) <- names(C_G)

lapply(names(Rat_t), function(x) {
                   kable(Rat_t[[x]],
                   caption = paste0(x, "-Gene-PTB")) %>%  
                   kable_styling(full_width = F)})

```

Venn Plots
```{r fig.width=4, fig.height=4, fig.align='center',out.extra='angle=90', echo=FALSE}

for (i in seq_along(Rat_t)) {
        
        grid.newpage()
        draw.pairwise.venn(area1=Rat_t[[i]][1,3], area2=Rat_t[[i]][3,1],
                           cross.area=Rat_t[[i]][1,1], alpha=rep(.5,2),
                           ext.text=F,cex=c(1.8,1.4,1.8),cat.cex=rep(1.3,2),
                           cat.pos = rep( ifelse( abs(Rat_t[[i]][1,3]-
                                                  Rat_t[[i]][3,1]) <
                                                  500, 165, 330), 2), 
                           cat.dist=rep(0.025,2),rotation.degree = 50,
                           cat.col = c("dodgerblue3","firebrick4"),
                           category=c(names(Rat_t)[i], "Preterm Birth"),
                           lty=rep("blank",2), fill=c("light blue", "pink"), 
                           label.col=c("dodgerblue3", "black", "firebrick4"))
}

```

# Tests and Results (Rat)

## Chi-Squared Test

```{r warning=FALSE}
# see whether chi-squared distribution can be satisfied for each chemical
try_chisq <- try(lapply(Rat_t, function(x) chisq.test(x[1:2,1:2], correct=F)))

chi_rat <- sapply(try_chisq, function(y) {
        
        # when there're low expected cell count, using 'N-1' chi-square
        if (y$expected[1,1]>=1 & y$expected[1,2]>=1 & y$expected[2,1]>=1 & y$expected[2,2]>=1) {
                if (y$expected[1,1]<5|y$expected[1,2]<5|y$expected[2,1]<5|y$expected[2,2]<5) {
                        chisq <- (y$statistic)*N/(N-1)
                        newp  <- pchisq(chisq, df=1, lower.tail=F)
                        cell_count <- "< 5"
                }
                else  {
                        chisq <- y$statistic
                        newp  <- y$p.value
                        cell_count <- round(y$expected[1,1], 2)
                }
        }
        else {
                chisq <- NA
                newp  <- NA
                cell_count <- "< 1"
        }
        
        return(c(chisq_rat=chisq, newp_rat=newp, cell_count_rat=cell_count))
})
chi_rat <- as.data.frame(chi_rat)
Chi_Squared_Stat_rat <- chi_rat["chisq_rat",]  %>% unfactor %>% t %>% as.data.frame
Chi_Squared_p_value_rat <- chi_rat["newp_rat",] %>% unfactor %>% t %>% as.data.frame
```

## Fisher's Enrichment Test
```{r}
# Fisher test
fisher_rat <- lapply(Rat_t, function(x) fisher.test(x[1:2,1:2]))

# Extract fisher OR's
Fisher_Odds_Ratio_rat <- do.call(rbind.data.frame, lapply(fisher_rat, function(x) x$estimate))

# Extract fisher p-values
Fisher_p_value_rat  <- do.call(rbind.data.frame, lapply(fisher_rat, function(x) x$p.value))

# Extract fisher CI
Fisher_lower_rat <- do.call(rbind.data.frame, lapply(fisher_rat, function(x) x$conf.int[1]))
Fisher_upper_rat <- do.call(rbind.data.frame, lapply(fisher_rat, function(x) x$conf.int[2]))
```

## PRR
```{r}
# PRR matrix, containing PRR values, lower bounds and upper bounds
PRR_rat <- as.data.frame(sapply(Rat_t, function(x) {
                                PRR <- (x[1,1]/x[1,3])/(x[2,1]/x[2,3])
                                s <- sqrt(1/x[1,1] + 1/x[2,1] - 
                                          1/(x[1,1]+x[1,2])   - 
                                          1/(x[2,1]+x[2,2]))
                                prr.low <- PRR/exp(1.96*s)
                                prr.up  <- PRR*exp(1.96*s)
                
                                PRR <- rbind(PRR, s, prr.low, prr.up)
}))

# extract PRR values
prr_rat <- t(PRR_rat[1,])
```

## Statistical Tests for each chemical by Preterm Birth in Rat
```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height = 4, fig.width = 6,fig.align="center"}
Table_rat <- cbind.data.frame(Chi_Squared_Stat_rat, Chi_Squared_p_value_rat, 
                              Fisher_Odds_Ratio_rat, Fisher_p_value_rat, prr_rat) %>% na.omit

colnames(Table_rat) <- c("Chi_Squared_Stat", "Chi_Squared_p_value", 
                         "Fisher_Odds_Ratio", "Fisher_p_value", "PRR")

Table_rat$Chi_Squared_p_value <-p.adjust(Table_rat$Chi_Squared_p_value, method="bonferroni")
Table_rat$Fisher_p_value <-p.adjust(Table_rat$Fisher_p_value, method="bonferroni")

sum_rat <- cbind.data.frame(Chi_Squared_Stat_rat,  Chi_Squared_p_value_rat, 
                            Fisher_Odds_Ratio_rat, Fisher_p_value_rat, prr_rat) 
sum_rat[which(rownames(sum_rat) %in% rownames(Table_rat)), ] = Table_rat
sum_rat <- cbind.data.frame(sum_rat[,-5], Fisher_lower_rat, Fisher_upper_rat, t(PRR_rat))
sum_rat[apply(is.na(sum_rat), 1, any),] <- NA

colnames(sum_rat) <- c("Chi_Squared_Stat", "Chi_Squared_p_value", 
                       "Fisher_Odds_Ratio", "Fisher_p_value", 
                       "Fisher_CI_lower", "Fisher_CI_upper", 
                       "PRR", "sqrt", "PRR_CI_lower", "PRR_CI_upper")

for (i in 1:nrow(Table_rat)) {
        for (j in 1:ncol(Table_rat)) {
               if (Table_rat[i,j]< 0.0005/nrow(Table_rat)) Table_rat[i,j] <- "< 0.000"
               else Table_rat[i,j] <- round(as.numeric(Table_rat[i,j]), 4) 
        }
}

kable(Table_rat,
      caption=paste("Statistical Tests for each chemical by 
                     Preterm Birth in rat 
                     ( CUT-OFF =", round(0.05/nrow(Table_rat), 4),
                    ")")) %>% 
      kable_styling(full_width = F)
```

## Cross Validation
```{r echo=FALSE,results='hide',fig.keep='all',message=FALSE}
cv_int  <- list(); cv_gene <- list(); cv_rac  <- list()
chisq_test <- array(); fisher_test <- array()

lapply(cut_offs, function(N0_) {
        
        for (i in 1:1000) {
                
                # random sample
                cv_int[[i]]  <- sample.int(N, N0_)              
                cv_gene[[i]] <- Genes$Rat[cv_int[[i]],]      
                # find interactions between random sample and Disease-Gene list of rat
                cv_rac[[i]]  <- cv_gene[[i]][which(toupper(cv_gene[[i]]$Symbol) %in% D_G$Rat$GeneSymbol),] 
        
                a = nrow(cv_rac[[i]])
                b = N0_ - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - N0_; 
                N_1 = N - N_0;
        
                Table <- matrix(c(a,b,N0_,c,d,N1_,N_0,N_1,N), ncol=3, byrow=T)
                colnames(Table) <- c("Yes","No","Total"); 
                rownames(Table) <- c("Yes","No","Total")
                Table <- as.data.frame.matrix(Table)
                
                if (N0_ <= 1000) {
                        chisq_res <- chisq.test(Table[1:2,1:2], simulate.p.value=T)
                        chisq_test[i] <- chisq_res$p.value
                } else {
                        chisq_res <- chisq.test(Table[1:2,1:2], correct=F)
                        chisq_test[i] <- chisq_res$p.value       
                }
                
                
                fisher_res <- fisher.test(Table[1:2,1:2])
                fisher_test[i] <- fisher_res$p.value
                
        }

        hist(chisq_test, las=1, col="dodgerblue", breaks=20,
             xlim=c(0,1), ylim=c(0,600),
             xlab="Chi-squared p-values for association",
             main=as.character(paste0("Chisq, Sample Size = ", N0_)))
        
         hist(fisher_test, las=1, col="darkorange", breaks=20,
             xlim=c(0,1), ylim=c(0,600),
             xlab="Fisher's test p-values for association",
             main=as.character(paste0("Fisher, Sample Size = ", N0_)))
})
```

### Summary plot of cross validation
```{r fig.width=8, fig.height=6, fig.align='center',out.extra='angle=90', echo=FALSE}
chisq_test_rat = fisher_test_rat <- data.frame(matrix(NA, nrow=1000, ncol=length(cut_offs)))
colnames(chisq_test_rat) = colnames(fisher_test_rat) <- paste("sample size =", cut_offs)

for(k in 1:length(cut_offs)) {
    for (i in 1:1000) {
                
                # random sample
                cv_int  <- sample.int(N, cut_offs[k])              
                cv_gene <- Genes$Rat[cv_int,]      
                # find interactions between random sample and Disease-Gene list of Mouse
                cv_rac  <- cv_gene[which(toupper(cv_gene$Symbol) %in% D_G$Rat$GeneSymbol),] 
                
                a = nrow(cv_rac)
                b = cut_offs[k] - a;
                c = N_0 - a;
                d = N-a-b-c;
                N1_ = N - cut_offs[k]; 
                N_1 = N - N_0;
                
                Table <- matrix(c(a,b,cut_offs[k],c,d,N1_,N_0,N_1,N), ncol=3, byrow=T)
                Table <- as.data.frame.matrix(Table)
                
                if (cut_offs[k] <= 1000) {
                        chisq_res  <- chisq.test(Table[1:2,1:2], simulate.p.value=T)
                        chisq_test_rat[i,k] <- chisq_res$p.value
                } else {
                        chisq_res  <- chisq.test(Table[1:2,1:2], correct=F)
                        chisq_test_rat[i,k] <- chisq_res$p.value       
                }
                
                
                fisher_res <- fisher.test(Table[1:2,1:2])
                fisher_test_rat[i,k] <- fisher_res$p.value
                
    }
}


plot(density(chisq_test_rat[,1]), lwd=1, col=cl[1], type = 'b',
     xlab="p-value for association", 
     ylab="Density", main="Chi-squared p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6){ lines(density(chisq_test_rat[,i]), lwd=1, col = cl[i], type = 'b') }
abline(v = 0.05/nrow(Table_rat), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_rat), 3)), col="black") 
legend("topleft", legend = colnames(chisq_test_rat), fill=cl[1:6], cex=0.75)

plot(density(fisher_test_rat[,1]), lwd=1, col=cl[1], type = 'b',
     xlab="p-value for association", 
     ylab="Density", main="Fisher Exact Test p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6) {lines(density(fisher_test_rat[,i]), lwd=1, col = cl[i], type = 'b')}
abline(v = 0.05/nrow(Table_rat), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_rat), 3)), col="black") 
legend("topleft", legend = colnames(fisher_test_rat), fill=cl[1:6], cex=0.75)

# use lines instead of dots and increase the density smoothing with "adjust"
plot(density(chisq_test_rat [,1], adjust=3), lwd=3, col=cl[1], type = 'l',
     xlab="p-value for association", 
     ylab="Density", main="Chi-squared p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6){ lines(density(chisq_test_rat [,i], adjust=3), lwd=3, col = cl[i], type = 'l') }
abline(v = 0.05/nrow(Table_rat), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_rat), 3)), col="black") 
legend("topleft", legend=colnames(chisq_test_rat), fill=cl[1:6], cex=0.75)

plot(density(fisher_test_rat[,1], adjust=3), lwd=3, col=cl[1], type = 'l',
     xlab="p-value for association", 
     ylab="Density", main="Fisher Exact Test p-values density plot",
     ylim=c(0,3), xlim=c(0,1), las=1, cex.lab=1, cex.main=1.5)
for (i in 2:6) {lines(density(fisher_test_rat [,i], adjust=3), lwd=3, col = cl[i], type = 'l')}
abline(v = 0.05/nrow(Table_rat), col="black", lwd=1, lty=2)
text(x=0.05, y=1.5,labels=paste0("cutoff=", round(0.05/nrow(Table_rat), 3)), col="black") 
legend("topleft", legend=colnames(fisher_test_rat), fill=cl[1:6], cex=0.75)
```


# Test Statistics Decision
```{r echo=TRUE, message=FALSE, warning=FALSE}

count_info <- rbind(chi_hum["cell_count_hum",],
                    chi_mus["cell_count_mus",],
                    chi_rat["cell_count_rat",]) %>% t %>% as.data.frame


count_info%>%
        mutate(
                Chemicals = row.names(.),
                
                Human = cell_spec(cell_count_hum, color = ifelse(cell_count_hum=="< 1", "red", 
                                                          ifelse(cell_count_hum=="< 5", "blue","black"))),
                Mouse = cell_spec(cell_count_mus, color = ifelse(cell_count_mus=="< 1", "red", 
                                                          ifelse(cell_count_mus=="< 5", "blue","black"))),
                Rat   = cell_spec(cell_count_rat, color = ifelse(cell_count_rat=="< 1", "red", 
                                                          ifelse(cell_count_rat=="< 5", "blue","black")))
        ) %>% 
        .[,-c(1:3)] %>%
        kable(escape = F, row.names=T) %>%
        kable_styling("striped", full_width = F)%>%
        group_rows("Dioxins", 1, 3)%>%
        group_rows("Furans", 4, 5)%>%
        group_rows("Metals", 6, 18)%>%
        group_rows("Other", 19, 20)%>%
        group_rows("Phthalates",21, 25)%>%
        group_rows("PAHs", 27, 28)%>% 
        group_rows("PCBs", 29, 35)%>%
        group_rows("PCPs", 36, 39)%>%
        group_rows("Pesticides", 40, 44)%>%
        group_rows("PFAS", 45, 50)%>%
        group_rows("Phytoestrogens", 51, 52)%>%
        group_rows("VOCs", 53, 59)
```

# Summary Plots

## Chi Squared Statistics plot
```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=5, fig.width=8,fig.align="center"}
dat_chisq <- data.frame(Chem=rep(names(C_G),3))

dat_chisq$X_squared =  c(sum_hum$Chi_Squared_Stat, 
                         sum_mus$Chi_Squared_Stat, 
                         sum_rat$Chi_Squared_Stat)

dat_chisq$Organism = as.factor(c(rep("Human",length(C_G)),
                                 rep("Mouse",length(C_G)),
                                 rep("Rat",length(C_G))))

colnames(dat_chisq) <- c("Chem", "X_squared", "Organism")

# plot
ggplot(data = dat_chisq, aes(x = Chem, y = X_squared, colour = Organism)) +
        labs(title="X-squared test",
             x ="Chemicals", y = "X-squared values") + 
        geom_point(aes(shape = Organism), size=4,
                   position = position_dodge(width = 0.2)) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size=8))
```

## Fisher Exact Test Statistics plot
### Fisher Exact Test Statistics plot-1
```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=8,fig.align="center"}
set1 <- rownames(sum_hum[which(is.na(sum_hum$Fisher_Odds_Ratio) == FALSE),])
set2 <- rownames(sum_mus[which(is.na(sum_mus$Fisher_Odds_Ratio) == FALSE),])
set3 <- rownames(sum_rat[which(is.na(sum_rat$Fisher_Odds_Ratio) == FALSE),])

set4=union(set1, set2)
dat_chem = union(set4, set3)
dat_chem1 <- rownames(sum_hum[which(rownames(sum_hum) %in% dat_chem),])

dat <- data.frame(Chem=rep(dat_chem1,3))
# fix the order of variables
dat$Chem <- factor(dat$Chem, levels=unique(dat$Chem))
dat$fisher.est =  c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_Odds_Ratio,
                    sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_Odds_Ratio,
                    sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_Odds_Ratio)

dat$fisher.low =  c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_CI_lower,
                    sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_CI_lower,
                    sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_CI_lower)

dat$fisher.up = c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_CI_upper,
                  sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_CI_upper,
                  sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_CI_upper)

dat$Organism = as.factor(c(rep("Human",length(dat_chem)),
                           rep("Mouse",length(dat_chem)),
                           rep("Rat",length(dat_chem))))

colnames(dat) <- c("Chem", "fisher.est", "fisher.low", "fisher.up", "Organism")

# plot
ggplot(data=dat, aes(x=Chem, y=fisher.est, ymin=fisher.low, ymax=fisher.up, colour=Organism)) +
        labs(title="Fisher exact test: Estimated enrichment and 95% CI",
             x ="Chemicals", y = "Enrichment Values") + 
        geom_point(aes(shape = Organism), size=4, position = position_dodge(width = 0.5)) +
        geom_errorbar(position = position_dodge(width = 0.5), width=1) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size=8))
```

### Fisher Exact Test Statistics plot-2
```{r echo=TRUE,message=FALSE,warning=FALSE,fig.keep='all',fig.height=6, fig.width=8,fig.align="center"}

forestplot(dat_chem1, 
           legend = c("Human", "Mouse", "Rat"),
           boxsize = .3, 
           line.margin = .1, 
           mean=cbind.data.frame(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_Odds_Ratio,
                                 sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_Odds_Ratio,
                                 sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_Odds_Ratio),
           lower=cbind.data.frame(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_CI_lower,
                                  sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_CI_lower,
                                  sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_CI_lower),
           upper=cbind.data.frame(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_CI_upper,
                                  sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_CI_upper,
                                  sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_CI_upper),
           clip=c(-1, 20),
           col=fpColors(box=c("firebrick2", "seagreen3", "dodgerblue1")),
           grid = structure(c(-.1, -.05, .05), 
                            gp = gpar(lty = 2, col = "#CCCCFF")), 
           
           zero = 1,
           xlab="Statistical Value of Fisher's Enrichment Test with 95% Confidence Interval")
```

## PRR plot
### PRR plot-1
```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=8,fig.align="center"}
dat_prr <- data.frame(Chem=rep(dat_chem1,3))
dat_prr$Chem <- factor(dat_prr$Chem, levels=unique(dat_prr$Chem))
dat_prr$prr = c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$PRR,
                sum_mus[which(rownames(sum_mus) %in% dat_chem),]$PRR,
                sum_rat[which(rownames(sum_rat) %in% dat_chem),]$PRR)

dat_prr$prr.low =  c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$PRR_CI_lower,
                     sum_mus[which(rownames(sum_mus) %in% dat_chem),]$PRR_CI_lower,
                     sum_rat[which(rownames(sum_rat) %in% dat_chem),]$PRR_CI_lower)

dat_prr$prr.up =  c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$PRR_CI_upper,
                    sum_mus[which(rownames(sum_mus) %in% dat_chem),]$PRR_CI_upper,
                    sum_rat[which(rownames(sum_rat) %in% dat_chem),]$PRR_CI_upper)

dat_prr$Organism = as.factor(c(rep("Human",length(dat_chem)),
                               rep("Mouse",length(dat_chem)),
                               rep("Rat",length(dat_chem))))

colnames(dat_prr) <- c("Chem", "PRR", "prr.low", "prr.up", "Organism")

# plot
ggplot(data=dat_prr,aes(x=Chem, y=PRR, ymin=prr.low, ymax=prr.up, colour=Organism)) +
        geom_point(aes(shape=Organism), size=4, position=position_dodge(width = 0.5)) +
        geom_errorbar(position = position_dodge(width = 0.5), width = 0.4) +
        labs(title="PRR and 95% CI", x ="Chemicals", y = "PRR Values")+
        theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1, size=10))
```

### PRR plot-2
```{r echo=TRUE,message=FALSE,warning=FALSE,fig.keep='all',fig.height=6, fig.width=8,fig.align="center"}
forestplot(dat_chem1, 
           legend = c("Homo sapiens", "Mus musculus", "Rattus norvegicus"),
           boxsize = .25, 
           line.margin = .1, 
           lwd.xaxis=1.5,
           lwd.ci=1.5,
           mean=cbind.data.frame(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$PRR,
                                 sum_mus[which(rownames(sum_mus) %in% dat_chem),]$PRR,
                                 sum_rat[which(rownames(sum_rat) %in% dat_chem),]$PRR),
           lower=cbind.data.frame(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$PRR_CI_lower,
                                  sum_mus[which(rownames(sum_mus) %in% dat_chem),]$PRR_CI_lower,
                                  sum_rat[which(rownames(sum_rat) %in% dat_chem),]$PRR_CI_lower),
           upper=cbind.data.frame(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$PRR_CI_upper,
                                  sum_mus[which(rownames(sum_mus) %in% dat_chem),]$PRR_CI_upper,
                                  sum_rat[which(rownames(sum_rat) %in% dat_chem),]$PRR_CI_upper),
           clip =c(-1, 17),
           col=fpColors(box=c("black","grey48","grey71"),
                        lines=c("black","grey48","grey71")),
           fn.ci_norm=c("fpDrawCircleCI",  "fpDrawNormalCI","fpDrawDiamondCI"), 
                            
           txt_gp = fpTxtGp(label = gpar(fontfamily="serif",fontface=0.9),
                            legend =gpar(fontfamily="serif",cex=0.9),
                            ticks = gpar(fontfamily="serif",cex=0.9),
                            xlab  = gpar(fontfamily="serif",cex=1)),
           zero = 1,
           xlab = "Prevalence Rate Ratio (PRR) with 95% Confidence Interval"
           )
```

## Chi Squared p-values plot
```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=8,fig.align="center"}
set1 <- rownames(sum_hum[which(is.na(sum_hum$Chi_Squared_p_value) == FALSE),])
set2 <- rownames(sum_mus[which(is.na(sum_mus$Chi_Squared_p_value) == FALSE),])
set3 <- rownames(sum_rat[which(is.na(sum_rat$Chi_Squared_p_value) == FALSE),])

set4=union(set1, set2)
dat_chi_pvalue = union(set4, set3)

dat_p_1 <- data.frame(Chem=rep(dat_chi_pvalue,3))
# fix the order of chemicals
dat_p_1$Chem <- factor(dat_p_1$Chem, levels=unique(dat_p_1$Chem))
dat_p_1$p_val =  c(sum_hum[which(rownames(sum_hum) %in% dat_chi_pvalue),]$Chi_Squared_p_value,
                   sum_mus[which(rownames(sum_mus) %in% dat_chi_pvalue),]$Chi_Squared_p_value,
                   sum_rat[which(rownames(sum_rat) %in% dat_chi_pvalue),]$Chi_Squared_p_value)

dat_p_1$p_val <- -log10(dat_p_1$p_val) 

dat_p_1$Organism = as.factor(c(rep("Human",length(dat_chi_pvalue)),
                               rep("Mouse",length(dat_chi_pvalue)),
                               rep("Rat",length(dat_chi_pvalue))))
p<-
ggplot(dat_p_1, aes(x=Chem, y=p_val, group=Organism)) +
        geom_point(aes(color=Organism, shape=Organism), size=4) +
        labs(title="X-Squared p-values", x ="Chemicals", y = "-log10(p-value)")+
        theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1, size=8)) +
        geom_hline(yintercept=-log10(0.05/nrow(Table_hum)), linetype="dashed", color=1)+
        geom_hline(yintercept=-log10(0.05/nrow(Table_mus)), linetype="dashed", color=2)+
        geom_hline(yintercept=-log10(0.05/nrow(Table_rat)), linetype="dashed", color=3)

ggdraw(add_sub(p, paste0("Human Cutoff=", round(-log10(0.05/nrow(Table_hum)),3),
                       "\nMouse Cutoff=", round(-log10(0.05/nrow(Table_hum)),3),
                       "\nRat Cutoff=",   round(-log10(0.05/nrow(Table_rat)),3))
))
```
## Fisher Exact Test p-values plot
```{r echo=TRUE, message=FALSE, warning=FALSE, fig.height=6, fig.width=8,fig.align="center"}
set1 <- rownames(sum_hum[which(is.na(sum_hum$Fisher_p_value) == FALSE),])
set2 <- rownames(sum_mus[which(is.na(sum_mus$Fisher_p_value) == FALSE),])
set3 <- rownames(sum_rat[which(is.na(sum_rat$Fisher_p_value) == FALSE),])

set4=union(set2, set3)
dat_chi_pvalue = union(set4, set1)

dat_p_2 <- data.frame(Chem=rep(dat_chi_pvalue,3))
# fix the order of chemicals
dat_p_2$Chem <- factor(dat_p_2$Chem, levels=unique(dat_p_2$Chem))
dat_p_2$p_val = c(sum_hum[which(rownames(sum_hum) %in% dat_chem),]$Fisher_p_value,
                  sum_mus[which(rownames(sum_mus) %in% dat_chem),]$Fisher_p_value,
                  sum_rat[which(rownames(sum_rat) %in% dat_chem),]$Fisher_p_value)
dat_p_2$p_val <- -log10(dat_p_2$p_val)
dat_p_2$Organism = as.factor(c(rep("Human",length(dat_chi_pvalue)),
                               rep("Mouse",length(dat_chi_pvalue)),
                               rep("Rat",length(dat_chi_pvalue))))
g<-
ggplot(dat_p_2, aes(x=Chem, y=p_val, group=Organism)) +
        geom_point(aes(color=Organism, shape=Organism), size=4) +
        labs(title="Fisher Exact test p-values", x ="Chemicals", y = "log10(p-value)")+
        theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1, size=8)) +
        geom_hline(yintercept=-log10(0.05/nrow(Table_hum)), linetype="dashed", color=1)+
        geom_hline(yintercept=-log10(0.05/nrow(Table_mus)), linetype="dashed", color=2)+
        geom_hline(yintercept=-log10(0.05/nrow(Table_rat)), linetype="dashed", color=3)

ggdraw(add_sub(g, paste0("Human Cutoff=", round(-log10(0.05/nrow(Table_hum)),3),
                       "\nMouse Cutoff=", round(-log10(0.05/nrow(Table_hum)),3),
                       "\nRat Cutoff=",   round(-log10(0.05/nrow(Table_rat)),3))
))
```



































  